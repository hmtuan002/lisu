
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bản Đồ Lịch Sử với AI Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#1e1b4b',
                        accent: '#10b981',
                        dark: '#0f172a',
                        light: {
                            bg: '#f8fafc',
                            sidebar: '#ffffff',
                            text: '#1e293b',
                            hover: '#e2e8f0'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'Calibri', 'sans-serif'],
                        display: ['Arial', 'sans-serif']
                    },
                    boxShadow: {
                        'soft': '0 4px 14px 0 rgba(0, 0, 0, 0.05)',
                        'soft-lg': '0 10px 28px rgba(0, 0, 0, 0.08)'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', 'Calibri', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .code-block {
            position: relative;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .code-header {
            font-family: 'Fira Code', monospace;
            user-select: none;
            background-color: #334155;
            color: #e2e8f0;
            font-size: 0.85rem;
        }

        .copy-code-btn {
            transition: all 0.2s;
            cursor: pointer;
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .copy-code-btn:hover {
            color: #ffffff;
        }

        pre {
            margin: 0 !important;
            padding: 1rem !important;
            background-color: #1e293b !important;
            border-radius: 0 0 0.75rem 0.75rem;
            color: #f8fafc;
            overflow-x: auto;
        }

        .markdown p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
            color: #334155;
        }

        .markdown ul,
        .markdown ol {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
        }

        .markdown li {
            margin-bottom: 0.5rem;
            color: #334155;
        }

        .markdown code:not(pre code) {
            background-color: #e2e8f0;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Fira Code', monospace;
            color: #334155;
            font-size: 0.9em;
        }

        .markdown strong {
            font-weight: 600;
            color: #1e293b;
        }

        .markdown em {
            font-style: italic;
        }

        .markdown h1,
        .markdown h2,
        .markdown h3,
        .markdown h4 {
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            color: #1e293b;
            font-family: 'Arial', sans-serif;
        }

        .markdown h1 {
            font-size: 1.5rem;
            line-height: 2rem;
        }

        .markdown h2 {
            font-size: 1.25rem;
            line-height: 1.75rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .markdown h3 {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }

        .markdown h4 {
            font-size: 1rem;
            line-height: 1.5rem;
        }

        .markdown table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .markdown th,
        .markdown td {
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            text-align: left;
        }

        .markdown th {
            background-color: #f1f5f9;
            font-weight: 600;
        }

        .markdown blockquote {
            border-left: 4px solid #94a3b8;
            padding-left: 1rem;
            margin: 1.25rem 0;
            color: #64748b;
            border-radius: 0.5rem;
            background-color: #f8fafc;
        }

        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 10;
        }

        /* Battle box styles - đã chỉnh sửa */
        .battle-box {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .battle-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .battle-box h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #4f46e5;
            display: flex;
            align-items: center;
            font-family: 'Arial', sans-serif;
        }

        .battle-box h3 i {
            margin-right: 0.5rem;
            color: #4f46e5;
        }

        .battle-box h3 i.fa-star {
            color: #f43f5e;
        }

        .battle-box ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .battle-box p,
        .battle-box li {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #475569;
        }

        /* Mindmap styles - đã chỉnh sửa */
        .mindmap-container {
            width: 100%;
            height: 400px;
            background-color: #ffffff;
            border-radius: 0.75rem;
            margin: 1rem 0;
            overflow: auto;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .mindmap-container.expanded {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            margin: 0;
            border-radius: 0;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.95);
        }

        .mindmap {
            width: 100%;
            height: 100%;
            min-height: 400px;
            padding: 1rem;
            background-color: transparent !important;
        }

        .mindmap-title {
            text-align: center;
            font-weight: 600;
            margin: 0;
            padding: 1rem;
            color: #4f46e5;
            font-size: 1.1rem;
            border-bottom: 1px solid #e2e8f0;
            background-color: #f8fafc;
            border-radius: 0.75rem 0.75rem 0 0;
            font-family: 'Arial', sans-serif;
        }

        .loading-mindmap {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #64748b;
            font-size: 0.95rem;
        }

        .mindmap-error {
            color: #ef4444;
            padding: 1.5rem;
            text-align: center;
            font-size: 0.95rem;
        }

        /* Custom Mermaid styles với màu sắc đa dạng */
        .mermaid .node rect,
        .mermaid .node circle,
        .mermaid .node polygon {
            fill: #ffffff !important;
            stroke-width: 2px !important;
            rx: 8px !important;
            ry: 8px !important;
            transition: all 0.2s ease;
        }

        .mermaid .node text {
            fill: #1e293b !important;
            font-family: 'Inter', sans-serif !important;
            font-size: 14px !important;
            font-weight: 500 !important;
        }

        .mermaid .edgePath .path {
            stroke: #94a3b8 !important;
            stroke-width: 2px !important;
        }

        .mermaid .arrowheadPath {
            fill: #94a3b8 !important;
        }

        /* Color themes for mindmap nodes */
        .mermaid .root-node rect {
            fill: #4f46e5 !important;
            stroke: #3730a3 !important;
        }

        .mermaid .root-node text {
            fill: #ffffff !important;
        }

        .mermaid .time-node rect {
            fill: #10b981 !important;
            stroke: #059669 !important;
        }

        .mermaid .time-node text {
            fill: #ffffff !important;
        }

        .mermaid .location-node rect {
            fill: #0ea5e9 !important;
            stroke: #0284c7 !important;
        }

        .mermaid .location-node text {
            fill: #ffffff !important;
        }

        .mermaid .faction-node rect {
            fill: #f59e0b !important;
            stroke: #d97706 !important;
        }

        .mermaid .faction-node text {
            fill: #ffffff !important;
        }

        .mermaid .commander-node rect {
            fill: #ec4899 !important;
            stroke: #db2777 !important;
        }

        .mermaid .commander-node text {
            fill: #ffffff !important;
        }

        .mermaid .outcome-node rect {
            fill: #8b5cf6 !important;
            stroke: #7c3aed !important;
        }

        .mermaid .outcome-node text {
            fill: #ffffff !important;
        }

        .mermaid .significance-node rect {
            fill: #14b8a6 !important;
            stroke: #0d9488 !important;
        }

        .mermaid .significance-node text {
            fill: #ffffff !important;
        }

        .mermaid .achievement-node rect {
            fill: #f97316 !important;
            stroke: #ea580c !important;
        }

        .mermaid .achievement-node text {
            fill: #ffffff !important;
        }

        .mermaid .purpose-node rect {
            fill: #a855f7 !important;
            stroke: #9333ea !important;
        }

        .mermaid .purpose-node text {
            fill: #ffffff !important;
        }

        .mermaid .architecture-node rect {
            fill: #3b82f6 !important;
            stroke: #2563eb !important;
        }

        .mermaid .architecture-node text {
            fill: #ffffff !important;
        }

        .mermaid .content-node rect {
            fill: #84cc16 !important;
            stroke: #65a30d !important;
        }

        .mermaid .content-node text {
            fill: #ffffff !important;
        }

        .mermaid .builder-node rect {
            fill: #f43f5e !important;
            stroke: #e11d48 !important;
        }

        .mermaid .builder-node text {
            fill: #ffffff !important;
        }

        .mermaid .dynasty-node rect {
            fill: #06b6d4 !important;
            stroke: #0891b2 !important;
        }

        .mermaid .dynasty-node text {
            fill: #ffffff !important;
        }

        /* History info box - đã chỉnh sửa */
        .history-info-box {
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #4f46e5;
            transition: all 0.3s ease;
            width: 100%;
        }

        /* Result container - đã chỉnh sửa */
        .result-container {
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
            width: 100%;
        }

        .result-container .result-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-info-box .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #94a3b8;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10;
        }

        .history-info-box .close-btn:hover {
            color: #64748b;
        }

        #stop-response-btn:active {
            transform: scale(0.95);
            background-color: #dc2626 !important;
        }

        #stop-response-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Image container - đã chỉnh sửa */
        .image-container {
            width: 100%;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .image-container.expanded {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            margin: 0;
            border-radius: 0;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .image-content {
            width: 100%;
            height: 300px; /* Chiều cao cố định */
            object-fit: cover; /* Cắt ảnh tỉ lệ */
            border-radius: 0;
            transition: all 0.3s ease;
            display: block;
        }

        .image-container.expanded .image-content {
            width: auto;
            height: auto;
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
        }

        .image-title {
            text-align: center;
            font-weight: 600;
            margin: 0;
            padding: 0.75rem 1rem;
            color: #4f46e5;
            font-size: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background-color: #f8fafc;
            font-family: 'Arial', sans-serif;
        }

        .image-container.expanded .image-title {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0;
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }

        /* Scrollbar for mindmap */
        .mindmap-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .mindmap-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .mindmap-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .mindmap-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .search-input {
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-family: 'Inter', sans-serif;
        }

        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .sidebar-header {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .message-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Country highlight styles */
        .leaflet-tooltip {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: #000;
            font-weight: bold;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white;
            padding: 0 !important;
            font-family: 'Arial', sans-serif;
        }

        .country-highlight {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% {
                fill-opacity: 0.3;
            }

            50% {
                fill-opacity: 0.8;
            }

            100% {
                fill-opacity: 0.3;
            }
        }

        .history-info-box:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .close-btn {
            float: right;
            cursor: pointer;
            font-size: 1.25rem;
            color: #94a3b8;
            transition: color 0.2s;
            margin-left: 1rem;
        }

        .close-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .inline-block:hover .close-btn,
        .mindmap-title:hover .close-btn {
            opacity: 1;
        }

        .chat-input-container {
            position: sticky;
            bottom: 0;
            background-color: #ffffff;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            z-index: 10;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: calc(100vh - 200px);
            margin-bottom: 0;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        /* Floating action buttons */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #4f46e5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
            background-color: #4338ca;
        }

        .fab-sidebar {
            position: fixed;
            bottom: 8rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .fab-sidebar:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
            background-color: #059669;
        }

        /* Gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animated border */
        .animated-border {
            position: relative;
        }

        .animated-border::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #4f46e5, #10b981);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .animated-border:hover::after {
            transform: scaleX(1);
        }

        /* Pulse animation */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Battle marker styles */
        .battle-marker {
            background-color: #ef4444;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
            animation: pulse 1.5s infinite;
        }

        /* Audio controls - đã chỉnh sửa */
        .audio-controls {
            display: flex;
            flex-direction: column;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            width: 100%;
        }

        .audio-controls-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #4f46e5;
            font-size: 1rem;
        }

        .audio-controls-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .audio-controls button {
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .audio-controls button:hover {
            background-color: #4338ca;
        }

        .audio-controls button:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
        }

        .audio-progress {
            flex-grow: 1;
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
            margin-left: 0.5rem;
        }

        .audio-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #4f46e5;
            width: 0%;
            transition: width 0.1s linear;
        }

        /* Key locations styles */
        .key-location {
            background-color: #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .key-location::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(59, 130, 246, 0.2);
            animation: ripple 2s infinite;
        }

        @keyframes ripple {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Sidebar toggle */
        .sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: -1.5rem;
            width: 3rem;
            height: 3rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background-color: #4338ca;
            transform: scale(1.1);
        }

        .sidebar-collapsed {
            transform: translateX(-100%);
            position: absolute;
            left: -100%;
            background-color: transparent;
            box-shadow: none;
            border-right: none;
        }

        .sidebar-collapsed .sidebar-toggle {
            right: -3rem;
        }

        /* App container */
        #app {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            height: 100vh;
        }

        #sidebar {
            width: 384px;
            height: 100%;
            background-color: #ffffff;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            position: absolute;
            left: 0;
            top: 0;
            z-index: 20;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        #map-container {
            flex: 1;
            height: 100%;
            margin-left: 0;
            position: relative;
            z-index: 10;
        }

        .ai-result-content {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .info-section {
            margin: 10px 0;
        }

        .info-section span {
            font-weight: bold;
        }

        /* Language toggle switch - đã chỉnh sửa */
        .language-switch {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 0.5rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4f46e5;
            transition: .4s;
            border-radius: 34px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            z-index: 2;
        }

        .slider .vi-text {
            opacity: 1;
            transition: opacity 0.3s;
        }

        .slider .en-text {
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        input:checked + .slider {
            background-color: #10b981;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        input:checked + .slider .vi-text {
            opacity: 0.5;
        }

        input:checked + .slider .en-text {
            opacity: 1;
        }

        .language-label {
            display: none; /* Ẩn label bên ngoài */
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header-title {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Content container */
        .content-container {
            flex: 1;
            padding: 1rem;
            background-color: #f8fafc;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Timeline styles */
        .timeline-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            width: 100%;
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1rem;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #4f46e5;
            border: 2px solid #ffffff;
            z-index: 1;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: 1rem;
            top: 1.25rem;
            bottom: -1rem;
            width: 2px;
            background-color: #e2e8f0;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .timeline-content {
            background-color: #f8fafc;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border-left: 3px solid #4f46e5;
        }

        .timeline-time {
            font-weight: 600;
            color: #4f46e5;
            margin-bottom: 0.25rem;
            font-family: 'Arial', sans-serif;
        }

        .timeline-text {
            color: #475569;
        }

        /* Loading screen - đã thêm */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .loading-screen.active {
            opacity: 1;
            visibility: visible;
        }

        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner-box {
            width: 200px;
            height: 200px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes spin3D {
            from { transform: rotate3d(.5,.5,.5, 360deg); }
            to { transform: rotate3d(0deg); }
        }

        .leo-border-1 {
            position: absolute;
            width: 100px;
            height: 100px;
            padding: 3px;
            border-radius: 50%;
            background: linear-gradient(0deg, rgba(63,249,220,0.1) 33%, rgba(63,249,220,1) 100%);
            animation: spin3D 1.8s linear infinite;
        }

        .leo-core-1 {
            width: 100%;
            height: 100%;
            background-color: transparent;
            border-radius: 50%;
        }

        .leo-border-2 {
            position: absolute;
            width: 100px;
            height: 100px;
            padding: 3px;
            border-radius: 50%;
            background: linear-gradient(0deg, rgba(251,91,83,0.1) 33%, rgba(251,91,83,1) 100%);
            animation: spin3D 2.2s linear infinite reverse;
        }

        .leo-core-2 {
            width: 100%;
            height: 100%;
            background-color: transparent;
            border-radius: 50%;
        }

        .loading-text {
            margin-top: 30px;
            font-size: 20px;
            font-weight: 600;
            color: #333;
            text-align: center;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .loader-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            text-align: center;
            max-width: 300px;
            line-height: 1.5;
        }

        /* Result messages container */
        #result-messages {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }

        /* Country history styles */
        #country-history {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #475569;
        }

        /* Map click handler */
        .map-click-handler {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            cursor: pointer;
        }
    </style>
</head>

<body class="h-screen flex flex-col gradient-bg text-light-text transition-all">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loader-container">
            <div class="spinner-box">
                <div class="leo-border-1">
                    <div class="leo-core-1"></div>
                </div>
                <div class="leo-border-2">
                    <div class="leo-core-2"></div>
                </div>
            </div>
            <div class="loading-text" id="loadingText">AI đang tạo nội dung...</div>
            <div class="loader-info">
                Đang xử lý yêu cầu của bạn. Vui lòng chờ trong giây lát...
            </div>
        </div>
    </div>

    <div id="app">
        <div id="sidebar" class="flex flex-col h-full transition-all duration-300 relative">
            <div class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-chevron-left"></i>
            </div>

            <div class="p-6 sidebar-header">
                <div class="header-container">
                    <div class="header-title">
                        <h2 class="text-2xl font-bold text-gray-800 font-display flex items-center">
                            <i class="fas fa-map-marked-alt mr-3 text-primary"></i>
                            <span class="animated-border">Bản Đồ Lịch Sử</span>
                        </h2>
                    </div>
                    <div class="header-actions">
                        <div class="language-switch">
                            <label class="switch">
                                <input type="checkbox" id="language-toggle">
                                <span class="slider">
                                    <span class="vi-text">Vi</span>
                                    <span class="en-text">En</span>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <form id="search-form" class="relative mt-6">
                    <div class="relative">
                        <input id="search-input" type="text"
                            class="w-full p-4 rounded-xl border border-gray-300 bg-white search-input focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-gray-800 pl-12"
                            placeholder="Nhập sự kiện lịch sử, nhân vật hoặc địa danh..." />
                        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <i class="fas fa-search"></i>
                        </div>
                        <button type="submit"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-primary text-white p-2 rounded-lg hover:bg-secondary transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>

            <div class="content-container">
                <div id="result-messages" class="flex flex-col gap-4 w-full"></div>
                <div id="typing-indicator"
                    class="hidden mt-4 p-4 bg-blue-50 rounded-xl text-blue-700 text-sm flex items-center">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500 mr-3"></div>
                    <span>AI đang tìm kiếm, vui lòng đợi...</span>
                </div>
                <div id="stop-button-container" class="hidden mt-4">
                    <button id="stop-response-btn"
                        class="bg-red-500 hover:bg-red-600 text-white px-5 py-3 rounded-xl text-sm font-medium transition-colors flex items-center justify-center w-full">
                        <i class="fas fa-stop mr-2"></i> Dừng tìm kiếm
                    </button>
                </div>
            </div>
        </div>

        <div id="map-container" class="flex-1 flex flex-col h-full overflow-hidden relative">
            <div id="map" class="flex-1"></div>
            <div class="map-click-handler" onclick="closeHistoryInfo()"></div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const API_KEY = "AIzaSyD6X-ej_i43Q2CqAr-7JneL034L3MBxDKg";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const resultMessages = document.getElementById('result-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const stopButtonContainer = document.getElementById('stop-button-container');
        const loadingScreen = document.getElementById('loading-screen');
        const sidebar = document.getElementById('sidebar');
        const mapContainer = document.getElementById('map-container');
        const languageToggle = document.getElementById('language-toggle');

        let map;
        let abortController = null;
        let isSending = false;
        let isStopped = false;
        let markers = [];
        let currentQueries = [];
        let countryLayer = null;
        let selectedCountryLayer = null;
        let countryLayers = {};
        let speechSynthesisUtterance = null;
        let isSpeaking = false;
        let speechProgressInterval;
        let currentSpeechText = '';
        let keyLocations = [];

        // Translation dictionary
        const translations = {
            vi: {
                title: "Bản Đồ Lịch Sử",
                search_placeholder: "Nhập sự kiện lịch sử, nhân vật hoặc địa danh...",
                typing_indicator: "AI đang tìm kiếm, vui lòng đợi...",
                stop_button: "Dừng tìm kiếm",
                country_info_close: "Nhấp vào bản đồ để đóng thông tin",
                map_label: "Bản đồ lịch sử",
                battle_name: "Tên Nhân Vật",
                battle_time: "Thời Gian",
                battle_location: "Địa Điểm",
                battle_summary: "Tóm Tắt",
                battle_factions: "Các Phe Tham Gia",
                battle_troops: "Quân Số",
                latitude: "Vĩ độ",
                longitude: "Kinh độ",
                battle_commanders: "Chỉ Huy",
                battle_tactics: "Chiến Thuật",
                battle_casualties: "Thương Vong",
                battle_timeline: "Diễn Biến Chính",
                battle_outcome: "Kết Quả",
                battle_significance: "Tác động Lịch Sử",
                event: "Sự kiện",
                battle_heroes: "Anh Hùng Tiêu Biểu",
                mindmap_title: "Sơ Đồ Tư Duy",
                non_history_error: "Xin lỗi, tôi chỉ trả lời các câu hỏi liên quan đến lịch sử. Vui lòng nhập một truy vấn về lịch sử!",
                map_error: "Lỗi tải dữ liệu bản đồ, vui lòng thử lại sau.",
                processing_error: "Lỗi khi xử lý yêu cầu. Vui lòng thử lại!",
                copy_code: "Sao chép mã",
                birth_place: "Nơi sinh",
                figure_mindmap_title: "Sơ Đồ Tư Duy Nhân Vật",
                battle_achievements: "Thành Tựu Nổi Bật",
                copied: "Đã sao chép!",
                landmark_build_time: "Thời gian xây dựng",
                unknown: "Không xác định",
                no_summary: "Không có tóm tắt",
                ai_assistant: "Trợ Lý AI",
                close: "Đóng",
                picture: "Hình ảnh",
                map_marker: "Điểm đánh dấu bản đồ",
                play_audio: "Phát thuyết minh",
                pause_audio: "Tạm dừng",
                stop_audio: "Dừng",
                key_locations: "Địa điểm quan trọng",
                audio_progress: "Tiến trình",
                audio_controls: "Điều khiển âm thanh",
                timeline_title: "Diễn biến trận chiến",
                landmark_name: "Tên địa danh",
                landmark_purpose: "Mục đích xây dựng",
                landmark_architecture: "Kiến trúc",
                landmark_contents: "Nội dung bên trong",
                landmark_builders: "Người xây dựng",
                landmark_dynasty: "Triều đại",
                landmark_mindmap_title: "Sơ Đồ Tư Duy Địa Danh",
                loading_text_1: "AI đang tạo nội dung...",
                loading_text_2: "Đang xử lý dữ liệu...",
                loading_text_3: "Đang phân tích thông tin...",
                loading_text_4: "Đang tổng hợp nội dung..."
            },
            en: {
                title: "Historical Map",
                search_placeholder: "Enter historical event, figure or landmark...",
                typing_indicator: "AI is searching, please wait...",
                stop_button: "Stop Search",
                country_info_close: "Click the map to close the information",
                map_label: "Historical Map",
                battle_name: "Character Name",
                battle_time: "Time",
                battle_location: "Location",
                battle_summary: "Summary",
                picture: "Picture",
                battle_factions: "Participating Factions",
                battle_troops: "Troop Numbers",
                latitude: "Latitude",
                longitude: "Longitude",
                battle_commanders: "Commanders",
                battle_tactics: "Tactics",
                battle_casualties: "Casualties",
                battle_timeline: "Main Events",
                battle_outcome: "Outcome",
                birth_place: "Place of birth",
                battle_significance: "Historical Significance",
                battle_heroes: "Notable Heroes",
                event: "Event",
                mindmap_title: "Mind Map",
                figure_mindmap_title: "Character Mind Map",
                battle_achievements: "Notable Achievements",
                non_history_error: "Sorry, I only answer questions related to history. Please enter a history-related query!",
                map_error: "Error loading map data, please try again later.",
                processing_error: "Error processing request. Please try again!",
                copy_code: "Copy code",
                copied: "Copied!",
                landmark_build_time: "Construction Time",
                unknown: "Unknown",
                no_summary: "No summary available",
                ai_assistant: "AI Assistant",
                close: "Close",
                map_marker: "Map Marker",
                play_audio: "Play narration",
                pause_audio: "Pause",
                stop_audio: "Stop",
                key_locations: "Key locations",
                audio_progress: "Progress",
                audio_controls: "Audio controls",
                timeline_title: "Battle timeline",
                landmark_name: "Landmark Name",
                landmark_purpose: "Purpose of Construction",
                landmark_architecture: "Architecture",
                landmark_contents: "Contents Inside",
                landmark_builders: "Builders",
                landmark_dynasty: "Dynasty",
                landmark_mindmap_title: "Landmark Mind Map",
                loading_text_1: "AI is creating content...",
                loading_text_2: "Processing data...",
                loading_text_3: "Analyzing information...",
                loading_text_4: "Synthesizing content..."
            }
        };

        // Current language
        let currentLanguage = 'vi';

        // Function to update text based on language
        function updateLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            
            // Update search input placeholder
            searchInput.placeholder = translations[lang].search_placeholder;
            
            // Update title
            document.querySelector('.header-title span').textContent = translations[lang].title;
            
            // Update language toggle state
            languageToggle.checked = lang === 'en';
            
            // Update loading text
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = translations[lang].loading_text_1;
        }

        // Function to toggle language
        function toggleLanguage() {
            const newLang = languageToggle.checked ? 'en' : 'vi';
            updateLanguage(newLang);
        }

        // Function to show loading screen
        function showLoadingScreen() {
            loadingScreen.classList.add('active');
            
            // Update loading text animation
            const loadingText = document.getElementById('loadingText');
            const textVariations = [
                translations[currentLanguage].loading_text_1,
                translations[currentLanguage].loading_text_2,
                translations[currentLanguage].loading_text_3,
                translations[currentLanguage].loading_text_4
            ];
            
            let textIndex = 0;
            const textInterval = setInterval(() => {
                textIndex = (textIndex + 1) % textVariations.length;
                loadingText.textContent = textVariations[textIndex];
                
                // Hiệu ứng chuyển đổi text
                loadingText.style.opacity = '0.5';
                setTimeout(() => {
                    loadingText.style.opacity = '1';
                }, 200);
            }, 3000);
            
            // Lưu interval để clear khi tắt loading
            loadingScreen.textInterval = textInterval;
        }

        // Function to hide loading screen
        function hideLoadingScreen() {
            loadingScreen.classList.remove('active');
            if (loadingScreen.textInterval) {
                clearInterval(loadingScreen.textInterval);
            }
        }

        // Function to toggle sidebar
        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-collapsed');
            const toggleIcon = document.querySelector('.sidebar-toggle i');
            if (sidebar.classList.contains('sidebar-collapsed')) {
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
                mapContainer.style.marginLeft = '0';
            } else {
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
                mapContainer.style.marginLeft = '0';
            }
        }

        // Extended country name mapping
        const countryNameMap = {
            "Nguyễn Khuyến": "Vietnam",
            "Việt Nam": "Vietnam",
            "Anh": "United Kingdom",
            "Mỹ": "United States",
            "Hoa Kỳ": "United States",
            "Pháp": "France",
            "Đức": "Germany",
            "Nga": "Russia",
            "Nhật Bản": "Japan",
            "Trung Quốc": "China",
            "Trung Hoa": "China",
            "Hàn Quốc": "South Korea",
            "Ấn Độ": "India",
            "Brazil": "Brazil",
            "Canada": "Canada",
            "Ý": "Italy",
            "Tây Ban Nha": "Spain",
            "Bồ Đào Nha": "Portugal",
            "Thụy Điển": "Sweden",
            "Na Uy": "Norway",
            "Phần Lan": "Finland",
            "Đan Mạch": "Denmark",
            "Hà Lan": "Netherlands",
            "Bỉ": "Belgium",
            "Thụy Sĩ": "Switzerland",
            "Áo": "Austria",
            "Ba Lan": "Poland",
            "Hy Lạp": "Greece",
            "Thổ Nhĩ Kỳ": "Turkey",
            "Ai Cập": "Egypt",
            "Nam Phi": "South Africa",
            "Mexico": "Mexico",
            "Argentina": "Argentina",
            "Úc": "Australia",
            "New Zealand": "New Zealand",
            "Hà Nội": "Hanoi",
            "Huế": "Hue",
            "Trần Hưng Đạo": "Tran Hung Dao",
            "Nguyễn Huệ": "Nguyen Hue"
        };

        // Extended history data with translations
        const historyData = {
            "Australia": {
                history: {
                    vi: "Úc, một quốc gia lục địa ở Nam Bán Cầu, có lịch sử bản địa kéo dài hơn 60.000 năm với các dân tộc Thổ dân và Người dân đảo Torres Strait. Người châu Âu, chủ yếu là Anh, bắt đầu thuộc địa hóa vào năm 1788 với việc thành lập thuộc địa tù nhân ở New South Wales. Úc trở thành một liên bang độc lập vào năm 1901, thống nhất sáu thuộc địa. Thế kỷ 20, Úc phát triển mạnh nhờ khai thác khoáng sản và nông nghiệp, đồng thời tham gia các cuộc chiến tranh thế giới cùng phe Đồng minh. Ngày nay, Úc nổi tiếng với nền kinh tế phát triển, đa dạng văn hóa (nhờ nhập cư), và các biểu tượng như Nhà hát Opera Sydney, rạn san hô Great Barrier, và văn hóa Thổ dân độc đáo.",
                    en: "Australia, a continent-country in the Southern Hemisphere, has a history spanning over 60,000 years with Indigenous Aboriginal and Torres Strait Islander peoples. European colonization, primarily by the British, began in 1788 with the establishment of a penal colony in New South Wales. Australia became an independent federation in 1901, uniting six colonies. In the 20th century, it prospered through mining and agriculture and participated in global wars as part of the Allies. Today, Australia is known for its strong economy, cultural diversity (driven by immigration), and iconic landmarks like the Sydney Opera House, the Great Barrier Reef, and unique Indigenous culture."
                }
            },
            "Vietnam": {
                history: {
                    vi: "Việt Nam có lịch sử hơn 4.000 năm, bắt đầu từ thời các vua Hùng dựng nước Văn Lang, được xem là nhà nước đầu tiên trong truyền thuyết. Sau thời kỳ Bắc thuộc dưới sự cai trị của Trung Quốc, Việt Nam giành độc lập vào thế kỷ 10 dưới triều đại Ngô, Đinh, và các triều đại phong kiến như Lý, Trần, Hậu Lê, Nguyễn đã xây dựng một nền văn hóa đặc sắc với các di sản như Văn Miếu và chùa Một Cột. Thế kỷ 19, Việt Nam trở thành thuộc địa Pháp, dẫn đến các phong trào kháng chiến. Thế kỷ 20, Việt Nam đấu tranh giành độc lập qua các cuộc chiến chống Pháp và Mỹ, thống nhất đất nước năm 1975. Ngày nay, Việt Nam là một nền kinh tế đang phát triển nhanh, với văn hóa phong phú (phở, áo dài) và vai trò ngày càng quan trọng trong khu vực Đông Nam Á.",
                    en: "Vietnam's history spans over 4,000 years, beginning with the legendary Hung Kings who founded Van Lang, considered the first state in Vietnamese tradition. After centuries of Chinese domination, Vietnam gained independence in the 10th century under the Ngô and Đinh dynasties, followed by feudal dynasties like Lý, Trần, Later Lê, and Nguyễn, which built a distinct culture with landmarks like the Temple of Literature and One Pillar Pagoda. In the 19th century, Vietnam became a French colony, sparking resistance movements. The 20th century saw Vietnam fight for independence against France and the U.S., unifying in 1975. Today, Vietnam is a rapidly developing economy with a rich culture (phở, áo dài) and an increasingly significant role in Southeast Asia."
                }
            }
        };

        // Battle keywords
        const battleKeywords = ["trận chiến", "battle", "war", "engagement", "conflict", "campaign", "chiến tranh", "trận", "cuộc chiến", "chiến dịch", "đánh"];

        const countryCoordinates = {
            "Việt Nam": { lat: 16.0471, lng: 108.2062, zoom: 6 },
            "Trung Quốc": { lat: 35.8617, lng: 104.1954, zoom: 4 },
            "Mông Cổ": { lat: 46.8625, lng: 103.8467, zoom: 5 },
            "Pháp": { lat: 46.6034, lng: 1.8883, zoom: 5 },
            "Mỹ": { lat: 37.0902, lng: -95.7129, zoom: 4 },
            "Nhật Bản": { lat: 36.2048, lng: 138.2529, zoom: 5 },
            "Đức": { lat: 51.1657, lng: 10.4515, zoom: 5 },
            "Nga": { lat: 61.5240, lng: 105.3188, zoom: 3 }
        };

        // Historical locations in Vietnam with coordinates
        const vietnamHistoricalLocations = {
            "Điện Biên Phủ": {
                lat: 21.3867,
                lng: 103.0150,
                name: "Điện Biên Phủ",
                name_vi: "Điện Biên Phủ",
                name_en: "Dien Bien Phu",
                description: "Nơi diễn ra chiến dịch Điện Biên Phủ 1954",
                description_vi: "Điện Biên Phủ, tỉnh Điện Biên, nơi diễn ra chiến dịch Điện Biên Phủ năm 1954, đánh dấu chiến thắng lịch sử của Việt Nam trước thực dân Pháp",
                description_en: "Dien Bien Phu, Dien Bien Province, the site of the 1954 Dien Bien Phu Campaign, marking a historic victory of Vietnam over French colonial forces"
            },
            "Kinh thành Huế": { 
                lat: 16.4697, 
                lng: 107.5777, 
                name: "Kinh thành Huế", 
                name_vi: "Kinh thành Huế",
                name_en: "Hue Imperial City",
                description: "Trung tâm triều Nguyễn",
                description_vi: "Kinh thành Huế, trung tâm chính trị của triều Nguyễn từ 1802-1945",
                description_en: "Hue Imperial City, political center of the Nguyen Dynasty from 1802-1945"
            },
            "Thăng Long": { 
                lat: 21.0333, 
                lng: 105.8500, 
                name: "Thăng Long (Hà Nội)", 
                description: "Kinh đô thời Lý, Trần, Lê",
                name_vi: "Thăng Long (Hà Nội)",
                name_en: "Thang Long (Hanoi)",
                description_vi: "Kinh đô của Việt Nam thời Lý, Trần, Lê",
                description_en: "Capital of Vietnam during Ly, Tran, and Le dynasties"
            },
            "Bạch Đằng": { 
                lat: 20.8667, 
                lng: 106.7333, 
                name: "Sông Bạch Đằng", 
                description: "Nơi diễn ra các trận thủy chiến lừng danh",
                name_vi: "Sông Bạch Đằng",
                name_en: "Bach Dang River",
                description_vi: "Nơi diễn ra các trận thủy chiến lịch sử chống quân xâm lược",
                description_en: "Site of historic naval battles against invaders"
            }
        };

        function isBattleQuery(query) {
            const lowerQuery = query.toLowerCase();
            return battleKeywords.some(keyword => lowerQuery.includes(keyword.toLowerCase()));
        }

        function isFigureQuery(query) {
            const lowerQuery = query.toLowerCase();
            const figureKeywords = [
                "nhân vật", "vua", "hoàng đế", "tướng", "anh hùng", "nhà thơ", "nhà văn",
                "nguyễn huệ", "trần hưng đạo", "nguyễn khuyến", "quang trung",
                "lý thường kiệt", "ngô quyền", "chủ tịch", "bí thư", "character", "king", "emperor", "general", "hero", "poet", "writer", "Nguyễn Huệ", "Trần Hưng Đạo", "Nguyễn Khuyến", "Quang Trung", "Lý Thường Kiệt", "Ngô Quyền", "president", "secretary"
            ];
            return figureKeywords.some(keyword => lowerQuery.includes(keyword));
        }

        function isLandmarkQuery(query) {
            const lowerQuery = query.toLowerCase();
            const landmarkKeywords = [
                "kinh thành", "đền", "chùa", "di tích", "thành", "cung điện", "địa danh", "địa điểm", "lăng", "mộ",
                "huế", "thăng long", "cổ loa", "mỹ sơn", "văn miếu", "capital city", "temple", "pagoda", "heritage site", "fortress", "palace", "geographical name", "location", "tomb", "grave", "Hue", "Thang Long", "Co Loa", "My Son", "Van Mieu"
            ];
            return landmarkKeywords.some(keyword => lowerQuery.includes(keyword)) ||
                Object.keys(vietnamHistoricalLocations).some(loc =>
                    lowerQuery.includes(loc.toLowerCase()) ||
                    (vietnamHistoricalLocations[loc].name_en &&
                        lowerQuery.includes(vietnamHistoricalLocations[loc].name_en.toLowerCase()))
                );
        }

        function isCountryQuery(query) {
            const lowerQuery = query.toLowerCase();
            const countryKeywords = [
                "quốc gia", "đất nước", "nước", "lịch sử", "history", "country", "nation", "state",
                "Việt Nam", "Trung Quốc", "Mỹ", "Pháp", "Anh", "Nhật Bản", "Hàn Quốc",
                "Vietnam", "China", "USA", "France", "UK", "Japan", "Korea"
            ];
            return countryKeywords.some(keyword => lowerQuery.includes(keyword)) ||
                Object.keys(countryCoordinates).some(country => 
                    lowerQuery.includes(country.toLowerCase())
                );
        }

        function initApp() {
            initMap();
            setupEventListeners();
            mermaid.initialize({
                startOnLoad: false,
                theme: 'neutral',
                flowchart: {
                    useMaxWidth: false,
                    htmlLabels: true,
                    curve: 'basis',
                    nodeSpacing: 50,
                    rankSpacing: 100
                },
                mindmap: {
                    spacingFactor: 1.5,
                    nodeAlignment: 'center',
                    padding: 10
                },
                themeVariables: {
                    primaryColor: '#f8fafc',
                    primaryBorderColor: '#cbd5e1',
                    primaryTextColor: '#1e293b',
                    lineColor: '#94a3b8',
                    fontSize: '14px',
                    nodeBorder: '2px',
                    nodeBorderRadius: '12px',
                    clusterBorder: '2px',
                    clusterBorderRadius: '12px'
                }
            });
            updateLanguage('vi');
            languageToggle.addEventListener('change', toggleLanguage);
            
            // Check for URL parameters
            checkUrlParameters();
        }

        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('search');
            
            if (searchQuery) {
                // Decode and set the search query
                const decodedQuery = decodeURIComponent(searchQuery);
                searchInput.value = decodedQuery;
                
                // Trigger search after a short delay to ensure everything is loaded
                setTimeout(() => {
                    handleSubmit(null);
                }, 500);
            }
        }

        function initMap() {
            map = L.map('map').setView([16.0471, 108.2062], 3);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                .then(response => {
                    if (!response.ok) throw new Error('Không thể tải dữ liệu GeoJSON');
                    return response.json();
                })
                .then(data => {
                    const countriesLayer = L.geoJSON(data, {
                        style: {
                            fillColor: 'transparent',
                            fillOpacity: 0,
                            color: 'transparent',
                            weight: 0
                        },
                        onEachFeature: (feature, layer) => {
                            const countryName = feature.properties.name;
                            countryLayers[countryName] = layer;

                            layer.on('click', (e) => {
                                L.DomEvent.stopPropagation(e);
                                highlightCountry(countryName);
                            });
                        }
                    }).addTo(map);
                })
                .catch(error => {
                    console.error('Lỗi tải GeoJSON:', error);
                    addMessageToUI('assistant', translations[currentLanguage].map_error);
                });
        }

        function highlightCountry(countryName) {
            // Clear all previous results
            clearPreviousData();
            
            if (selectedCountryLayer) {
                selectedCountryLayer.setStyle({
                    color: 'transparent',
                    fillOpacity: 0
                });
                if (selectedCountryLayer.getElement) {
                    selectedCountryLayer.getElement().classList.remove('country-highlight');
                }
            }

            const countryLayer = countryLayers[countryName];
            if (countryLayer) {
                selectedCountryLayer = countryLayer;

                countryLayer.setStyle({
                    color: '#4f46e5',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.3,
                    fillColor: '#4f46e5'
                });

                if (countryLayer.getElement) {
                    countryLayer.getElement().classList.add('country-highlight');
                }
            }

            const translatedName = translateCountryName(countryName);
            const displayName = currentLanguage === 'en' ? translatedName : countryName;
            
            // Create history info box
            const historyInfoBox = document.createElement('div');
            historyInfoBox.className = 'history-info-box';
            historyInfoBox.innerHTML = `
                <div class="relative">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <span>
                            <i class="fas fa-flag mr-2 text-primary"></i>
                            ${displayName}
                        </span>
                    </h2>
                    <span class="absolute top-0 right-0 text-xl cursor-pointer text-gray-500 hover:text-gray-700" onclick="this.parentElement.parentElement.remove(); closeHistoryInfo();">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
                <div class="mt-4 text-gray-700">
                    <p class="mb-4">${historyData[translatedName]?.history[currentLanguage] || translations[currentLanguage].no_summary}</p>
                    <div class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span>${translations[currentLanguage].country_info_close}</span>
                    </div>
                </div>
            `;

            resultMessages.innerHTML = '';
            resultMessages.appendChild(historyInfoBox);

            if (countryCoordinates[countryName]) {
                const coords = countryCoordinates[countryName];
                map.setView([coords.lat, coords.lng], coords.zoom);
            }
            
            scrollToTop();
        }

        function closeHistoryInfo() {
            if (selectedCountryLayer) {
                selectedCountryLayer.setStyle({
                    color: 'transparent',
                    fillOpacity: 0
                });
                if (selectedCountryLayer.getElement) {
                    selectedCountryLayer.getElement().classList.remove('country-highlight');
                }
                selectedCountryLayer = null;
            }
        }

        function translateCountryName(name) {
            if (countryNameMap[name]) {
                return currentLanguage === 'en' ? countryNameMap[name] : name;
            }

            const lowerName = name.toLowerCase();
            for (const [viName, enName] of Object.entries(countryNameMap)) {
                if (viName.toLowerCase() === lowerName) {
                    return currentLanguage === 'en' ? enName : viName;
                }
            }

            return name;
        }

        function setupEventListeners() {
            searchForm.addEventListener('submit', handleSubmit);
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (searchInput.value.trim() !== '') {
                        searchForm.dispatchEvent(new Event('submit'));
                    }
                }
            });

            document.getElementById('stop-response-btn').addEventListener('click', () => {
                isStopped = true;
                stopButtonContainer.classList.add('hidden');
                typingIndicator.classList.add('hidden');
                hideLoadingScreen();

                if (abortController) {
                    abortController.abort();
                }

                stopSpeech();
            });
        }

        function clearPreviousData() {
            currentQueries = [];
            resultMessages.innerHTML = '';
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            keyLocations.forEach(loc => map.removeLayer(loc));
            keyLocations = [];
            if (countryLayer) {
                map.removeLayer(countryLayer);
                countryLayer = null;
            }
            closeHistoryInfo();
            stopSpeech();
        }

        async function handleSubmit(e) {
            if (e) e.preventDefault();

            stopSpeech();

            const userQuery = searchInput.value.trim();
            if (!userQuery || isSending) return;

            isSending = true;
            isStopped = false;
            clearPreviousData();

            currentQueries.push({
                role: "user",
                content: userQuery,
                timestamp: new Date().toISOString()
            });

            searchInput.value = "";
            typingIndicator.classList.remove("hidden");
            stopButtonContainer.classList.remove("hidden");
            showLoadingScreen();

            abortController = new AbortController();

            try {
                let prompt = userQuery;
                let responseType = "general";

                // Determine query type
                if (isCountryQuery(userQuery) && !isBattleQuery(userQuery) && !isFigureQuery(userQuery) && !isLandmarkQuery(userQuery)) {
                    // Handle country query
                    const countryName = extractCountryName(userQuery);
                    if (countryName) {
                        highlightCountry(countryName);
                        isSending = false;
                        typingIndicator.classList.add("hidden");
                        stopButtonContainer.classList.add("hidden");
                        hideLoadingScreen();
                        return;
                    }
                } else if (isFigureQuery(userQuery)) {
                    responseType = "figure";
                    prompt = `
TRẢ LỜI CHỈ BẰNG JSON KHÔNG CÓ BẤT KỲ VĂN BẢN NÀO KHÁC. Cung cấp thông tin về nhân vật lịch sử "${userQuery}" bằng ngôn ngữ ${currentLanguage === 'vi' ? 'tiếng Việt' : 'tiếng Anh'}. JSON phải có cấu trúc:
{
    "name": "Tên nhân vật",
    "time": "Thời gian sống (năm sinh - năm mất)",
    "location": "Địa điểm cụ thể liên quan (ưu tiên nơi sinh)",
    "lat": "Tọa độ vĩ độ của địa điểm (bắt buộc)",
    "lng": "Tọa độ kinh độ của địa điểm (bắt buộc)",
    "summary": "Tóm tắt tiểu sử",
    "achievements": ["Danh sách thành tựu nổi bật"],
    "significance": "Ý nghĩa lịch sử",
    "description_vi": "Mô tả ngắn gọn bằng tiếng Việt về mối liên hệ của địa điểm với nhân vật",
    "description_en": "Brief description in English about the connection between the location and the figure"
}
                    `;
                } else if (isBattleQuery(userQuery)) {
                    responseType = "battle";
                    prompt = `
TRẢ LỜI CHỈ BẰNG JSON KHÔNG CÓ BẤT KỲ VĂN BẢN NÀO KHÁC. Cung cấp thông tin về trận chiến "${userQuery}" bằng ngôn ngữ ${currentLanguage === 'vi' ? 'tiếng Việt' : 'tiếng Anh'}. JSON phải có cấu trúc:
{
    "name": "Tên trận chiến",
    "time": "Thời gian diễn ra",
    "location": "Địa điểm cụ thể diễn ra",
    "lat": "Tọa độ vĩ độ của địa điểm (bắt buộc)",
    "lng": "Tọa độ kinh độ của địa điểm (bắt buộc)",
    "summary": "Tóm tắt trận chiến",
    "factions": ["Danh sách các phe tham gia"],
    "troop_numbers": {"Phe": "Số quân"},
    "commanders": {"Phe": "Tên chỉ huy"},
    "tactics": {"Phe": "Chiến thuật sử dụng"},
    "casualties": {"Phe": "Số thương vong"},
    "heroes": [{"name": "Tên anh hùng", "role": "Vai trò", "description": "Mô tả đóng góp"}],
    "timeline": ["Các mốc sự kiện chính"],
    "outcome": "Kết quả trận chiến",
    "significance": "Ý nghĩa lịch sử",
    "key_locations": [{"name": "Tên địa điểm quan trọng", "description": "Mô tả tầm quan trọng"}]
}
                    `;
                } else if (isLandmarkQuery(userQuery)) {
                    responseType = "landmark";
                    prompt = `
TRẢ LỜI CHỈ BẰNG JSON KHÔNG CÓ BẮT KỲ VĂN BẢN NÀO KHÁC. Cung cấp thông tin về địa danh lịch sử "${userQuery}" bằng ngôn ngữ ${currentLanguage === 'vi' ? 'tiếng Việt' : 'tiếng Anh'}. JSON phải có cấu trúc:
{
    "name": "Tên địa danh",
    "location": "Địa điểm cụ thể (ví dụ: 'Huế, Thừa Thiên Huế')",
    "lat": "Tọa độ vĩ độ của địa điểm (bắt buộc)",
    "lng": "Tọa độ kinh độ của địa điểm (bắt buộc)",
    "build_time": "Thời gian xây dựng (ví dụ: '1804-1833' hoặc 'Thế kỷ 19')",
    "purpose": "Mục đích xây dựng địa danh",
    "architecture": "Phong cách kiến trúc hoặc đặc điểm kiến trúc",
    "contents": ["Danh sách các công trình hoặc vật phẩm nổi bật bên trong"],
    "builders": ["Danh sách những người có công xây dựng"],
    "dynasty": "Triều đại liên quan",
    "description_vi": "Mô tả ngắn gọn bằng tiếng Việt về ý nghĩa của địa danh",
    "description_en": "Brief description in English about the significance of the landmark"
}
                    `;
                } else {
                    prompt = `Trả lời truy vấn "${userQuery}" bằng ngôn ngữ ${currentLanguage === 'vi' ? 'tiếng Việt' : 'tiếng Anh'} với thông tin lịch sử chính xác và chi tiết.`;
                }

                const chatSession = model.startChat({
                    history: currentQueries.map(query => ({
                        role: query.role === "user" ? "user" : "model",
                        parts: [{ text: query.content }]
                    })),
                    generationConfig: {
                        maxOutputTokens: 2000,
                        temperature: 0.7,
                        topP: 0.1,
                        topK: 16,
                    }
                });

                if (isStopped) {
                    throw new Error("Search stopped by user");
                }

                const result = await chatSession.sendMessage(prompt, { signal: abortController.signal });

                if (isStopped) {
                    throw new Error("Search stopped by user");
                }

                const response = await result.response;
                let botReply = response.text();

                console.log("Phản hồi từ Gemini:", botReply);

                if (responseType === "landmark") {
                    try {
                        let jsonStr = botReply;
                        if (jsonStr.includes('```json')) {
                            jsonStr = jsonStr.split('```json')[1].split('```')[0].trim();
                        } else if (jsonStr.includes('```')) {
                            jsonStr = jsonStr.split('```')[1].split('```')[0].trim();
                        }

                        let landmarkData;
                        try {
                            landmarkData = JSON.parse(jsonStr);
                        } catch (e) {
                            jsonStr = jsonStr.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":');
                            landmarkData = JSON.parse(jsonStr);
                        }

                        // Create result container
                        const resultContainer = createResultContainer(landmarkData.name || userQuery);
                        
                        // Get image from Wikipedia
                        const imageUrl = await getWikipediaImage(landmarkData.name || userQuery);
                        landmarkData.imageUrl = imageUrl;

                        // Add image if available
                        if (imageUrl) {
                            const imageContainer = createImageContainer(landmarkData.name || userQuery, imageUrl);
                            resultContainer.querySelector('.result-content').appendChild(imageContainer);
                        }

                        // Add formatted data
                        const formattedData = formatLandmarkData(landmarkData);
                        resultContainer.querySelector('.result-content').innerHTML += formattedData;

                        // Add to result messages
                        resultMessages.appendChild(resultContainer);

                        if (landmarkData.lat && landmarkData.lng) {
                            addMarker(landmarkData.lat, landmarkData.lng, landmarkData.name || userQuery);
                            const zoomLevel = landmarkData.lat < 10 || landmarkData.lat > 30 ? 6 : 10;
                            map.setView([landmarkData.lat, landmarkData.lng], zoomLevel);
                        } else if (landmarkData.location) {
                            const location = await getLocationCoordinates(landmarkData.location);
                            if (location && location.lat && location.lng) {
                                addMarker(location.lat, location.lng, landmarkData.name || userQuery);
                                const zoomLevel = location.lat < 10 || location.lat > 30 ? 6 : 10;
                                map.setView([location.lat, location.lng], zoomLevel);
                            }
                        }

                        if (!isStopped) {
                            // Add mindmap
                            const mindmapDiv = createMindmapContainer(landmarkData.name || userQuery, translations[currentLanguage].landmark_mindmap_title);
                            resultContainer.querySelector('.result-content').appendChild(mindmapDiv);

                            await generateMindmap(landmarkData, mindmapDiv, "landmark");

                            // Add audio controls
                            const narrationText = generateNarrationText(landmarkData);
                            const audioControls = createAudioControls(narrationText, landmarkData.name || userQuery);
                            resultContainer.querySelector('.result-content').appendChild(audioControls);

                            currentQueries.push({
                                role: "assistant",
                                content: botReply,
                                timestamp: new Date().toISOString()
                            });
                        }
                    } catch (e) {
                        console.error("Lỗi phân tích JSON (địa danh):", e, "Phản hồi:", botReply);
                        botReply = `Thông tin về địa danh lịch sử:\n\n${botReply}`;
                        addMessageToUI("assistant", botReply);
                        currentQueries.push({
                            role: "assistant",
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                    }
                } else if (responseType === "figure") {
                    try {
                        let jsonStr = botReply;
                        if (jsonStr.includes('```json')) {
                            jsonStr = jsonStr.split('```json')[1].split('```')[0].trim();
                        } else if (jsonStr.includes('```')) {
                            jsonStr = jsonStr.split('```')[1].split('```')[0].trim();
                        }

                        let figureData;
                        try {
                            figureData = JSON.parse(jsonStr);
                        } catch (e) {
                            jsonStr = jsonStr.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":');
                            figureData = JSON.parse(jsonStr);
                        }

                        // Create result container
                        const resultContainer = createResultContainer(figureData.name || userQuery);
                        
                        // Get image from Wikipedia
                        const imageUrl = await getWikipediaImage(figureData.name || userQuery);
                        figureData.imageUrl = imageUrl;

                        // Add image if available
                        if (imageUrl) {
                            const imageContainer = createImageContainer(figureData.name || userQuery, imageUrl);
                            resultContainer.querySelector('.result-content').appendChild(imageContainer);
                        }

                        // Add formatted data
                        const formattedData = formatFigureData(figureData);
                        resultContainer.querySelector('.result-content').innerHTML += formattedData;

                        // Add to result messages
                        resultMessages.appendChild(resultContainer);

                        if (figureData.lat && figureData.lng) {
                            addMarker(figureData.lat, figureData.lng, figureData.name || userQuery);
                            const zoomLevel = figureData.lat < 10 || figureData.lat > 30 ? 6 : 10;
                            map.setView([figureData.lat, figureData.lng], zoomLevel);
                        } else if (figureData.location) {
                            const location = await getLocationCoordinates(figureData.location);
                            if (location && location.lat && location.lng) {
                                addMarker(location.lat, location.lng, figureData.name || userQuery);
                                const zoomLevel = location.lat < 10 || location.lat > 30 ? 6 : 10;
                                map.setView([location.lat, location.lng], zoomLevel);
                            }
                        }

                        if (!isStopped) {
                            // Add mindmap
                            const mindmapDiv = createMindmapContainer(figureData.name || userQuery, translations[currentLanguage].figure_mindmap_title);
                            resultContainer.querySelector('.result-content').appendChild(mindmapDiv);

                            await generateMindmap(figureData, mindmapDiv, "figure");
                            
                            // Add audio controls
                            const narrationText = generateNarrationText(figureData);
                            const audioControls = createAudioControls(narrationText, figureData.name || userQuery);
                            resultContainer.querySelector('.result-content').appendChild(audioControls);
                            
                            currentQueries.push({
                                role: "assistant",
                                content: botReply,
                                timestamp: new Date().toISOString()
                            });
                        }
                    } catch (e) {
                        console.error("Lỗi phân tích JSON (nhân vật):", e, "Phản hồi:", botReply);
                        botReply = `Thông tin về nhân vật lịch sử:\n\n${botReply}`;
                        addMessageToUI("assistant", botReply);
                        currentQueries.push({
                            role: "assistant",
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                    }
                } else if (responseType === "battle") {
                    try {
                        let jsonStr = botReply;
                        if (jsonStr.includes('```json')) {
                            jsonStr = jsonStr.split('```json')[1].split('```')[0].trim();
                        } else if (jsonStr.includes('```')) {
                            jsonStr = jsonStr.split('```')[1].split('```')[0].trim();
                        }

                        let battleData;
                        try {
                            if (!jsonStr.startsWith('{') && !jsonStr.startsWith('[')) {
                                throw new Error("Phản hồi không phải JSON hợp lệ");
                            }
                            battleData = JSON.parse(jsonStr);
                        } catch (e) {
                            console.error("Lỗi phân tích JSON đầu tiên:", e, "JSON thô:", jsonStr);
                            try {
                                jsonStr = jsonStr.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":')
                                    .replace(/'/g, '"')
                                    .replace(/,\s*}/g, '}')
                                    .replace(/,\s*]/g, ']');
                                battleData = JSON.parse(jsonStr);
                            } catch (e2) {
                                console.error("Lỗi phân tích JSON sau khi sửa:", e2, "JSON thô:", jsonStr);
                                botReply = `Thông tin về trận chiến:\n\n${botReply}`;
                                addMessageToUI("assistant", botReply);
                                currentQueries.push({
                                    role: "assistant",
                                    content: botReply,
                                    timestamp: new Date().toISOString()
                                });
                                return;
                            }
                        }

                        // Create result container
                        const resultContainer = createResultContainer(battleData.name || userQuery);
                        
                        // Get image from Wikipedia
                        const imageUrl = await getWikipediaImage(battleData.name || userQuery);
                        battleData.imageUrl = imageUrl;

                        // Add image if available
                        if (imageUrl) {
                            const imageContainer = createImageContainer(battleData.name || userQuery, imageUrl);
                            resultContainer.querySelector('.result-content').appendChild(imageContainer);
                        }

                        // Add formatted data
                        const formattedData = formatBattleData(battleData);
                        resultContainer.querySelector('.result-content').innerHTML += formattedData;

                        // Add to result messages
                        resultMessages.appendChild(resultContainer);

                        if (battleData.lat && battleData.lng) {
                            addMarker(battleData.lat, battleData.lng, battleData.name || userQuery);
                            const zoomLevel = battleData.lat < 10 || battleData.lat > 30 ? 6 : 10;
                            map.setView([battleData.lat, battleData.lng], zoomLevel);
                        } else if (battleData.location) {
                            const location = await getLocationCoordinates(battleData.location);
                            if (location && location.lat && location.lng) {
                                addMarker(location.lat, location.lng, battleData.name || userQuery);
                                const zoomLevel = location.lat < 10 || location.lat > 30 ? 6 : 10;
                                map.setView([location.lat, location.lng], zoomLevel);
                            }
                        }

                        if (battleData.factions && Array.isArray(battleData.factions)) {
                            const countries = await extractCountriesFromFactions(battleData.factions);
                            if (countries.length > 0) {
                                // Don't highlight countries for battle queries
                            }
                        }

                        if (battleData.key_locations && Array.isArray(battleData.key_locations) && battleData.key_locations.length > 0) {
                            for (const loc of battleData.key_locations) {
                                if (loc && loc.name) {
                                    const keyLocation = await getLocationCoordinates(loc.name);
                                    if (keyLocation && keyLocation.lat && keyLocation.lng) {
                                        addKeyLocationMarker(keyLocation.lat, keyLocation.lng, keyLocation.name, keyLocation.description || loc.description, keyLocations.length + 1);
                                    } else if (loc.lat && loc.lng) {
                                        addKeyLocationMarker(loc.lat, loc.lng, loc.name, loc.description, keyLocations.length + 1);
                                    }
                                }
                            }
                        }

                        if (!isStopped) {
                            // Add mindmap
                            const mindmapDiv = createMindmapContainer(battleData.name || userQuery, translations[currentLanguage].mindmap_title);
                            resultContainer.querySelector('.result-content').appendChild(mindmapDiv);

                            await generateMindmap(battleData, mindmapDiv, "battle");

                            // Add timeline if available
                            if (battleData.timeline && Array.isArray(battleData.timeline) && battleData.timeline.length > 0) {
                                const timelineDiv = document.createElement('div');
                                timelineDiv.className = 'timeline-container';
                                timelineDiv.innerHTML = `
                                    <h3 class="text-lg font-semibold mb-3 text-primary">
                                        <i class="fas fa-history mr-2"></i>
                                        ${translations[currentLanguage].timeline_title}
                                    </h3>
                                    ${battleData.timeline.map((event, index) => `
                                        <div class="timeline-item">
                                            <div class="timeline-content">
                                                <div class="timeline-time">${translations[currentLanguage].event} ${index + 1}</div>
                                                <div class="timeline-text">${event}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                `;
                                resultContainer.querySelector('.result-content').appendChild(timelineDiv);
                            }

                            // Add audio controls
                            const narrationText = generateNarrationText(battleData);
                            const audioControls = createAudioControls(narrationText, battleData.name || userQuery);
                            resultContainer.querySelector('.result-content').appendChild(audioControls);

                            currentQueries.push({
                                role: "assistant",
                                content: botReply,
                                timestamp: new Date().toISOString()
                            });
                        }
                    } catch (e) {
                        console.error("Lỗi phân tích JSON (trận chiến):", e, "Phản hồi:", botReply);
                        botReply = `Thông tin về trận chiến:\n\n${botReply}`;
                        addMessageToUI("assistant", botReply);
                        currentQueries.push({
                            role: "assistant",
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                    }
                } else {
                    if (!isStopped) {
                        addMessageToUI("assistant", botReply);
                        currentQueries.push({
                            role: "assistant",
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError' || error.message === "Search stopped by user") {
                    console.log("Tìm kiếm đã bị dừng bởi người dùng");
                    addMessageToUI("assistant", "Tìm kiếm đã dừng theo yêu cầu của bạn.");
                } else {
                    console.error("Lỗi trong handleSubmit:", error);
                    addMessageToUI("assistant", translations[currentLanguage].processing_error);
                }
            } finally {
                isSending = false;
                typingIndicator.classList.add("hidden");
                stopButtonContainer.classList.add("hidden");
                hideLoadingScreen();
                abortController = null;
                scrollToTop();
            }
        }

        function extractCountryName(query) {
            const lowerQuery = query.toLowerCase();
            for (const country in countryCoordinates) {
                if (lowerQuery.includes(country.toLowerCase())) {
                    return country;
                }
            }
            
            // Check Vietnamese names
            for (const [viName, enName] of Object.entries(countryNameMap)) {
                if (lowerQuery.includes(viName.toLowerCase())) {
                    return viName;
                }
            }
            
            return null;
        }

        function transliterateVietnamese(text) {
            const map = {
                'à': 'a', 'á': 'a', 'ả': 'a', 'ã': 'a', 'ạ': 'a',
                'è': 'e', 'é': 'e', 'ẻ': 'e', 'ẽ': 'e', 'ẹ': 'e',
                'ì': 'i', 'í': 'i', 'ỉ': 'i', 'ĩ': 'i', 'ị': 'i',
                'ò': 'o', 'ó': 'o', 'ỏ': 'o', 'õ': 'o', 'ọ': 'o',
                'ù': 'u', 'ú': 'u', 'ủ': 'u', 'ũ': 'u', 'ụ': 'u',
                'ỳ': 'y', 'ý': 'y', 'ỷ': 'y', 'ỹ': 'y', 'ỵ': 'y',
                'đ': 'd', 'â': 'a', 'ê': 'e', 'ô': 'o', 'ơ': 'o', 'ư': 'u'
            };
            return text.replace(/[àáảãạèéẻẽẹìíỉĩịòóỏõọùúủũụỳýỷỹỵđâêôơư]/g, match => map[match] || match)
                .replace(/\s+/g, ' ')
                .trim();
        }

        async function getLocationCoordinates(locationName) {
            try {
                if (!locationName) return null;

                const normalizedLocation = locationName.trim().toLowerCase();
                const transliteratedLocation = transliterateVietnamese(normalizedLocation);

                // Kiểm tra đặc biệt cho Điện Biên Phủ
                if (normalizedLocation.includes('điện biên phủ') ||
                    normalizedLocation.includes('dien bien phu') ||
                    transliteratedLocation.includes('dien bien phu')) {
                    const value = vietnamHistoricalLocations["Điện Biên Phủ"];
                    return {
                        lat: value.lat,
                        lng: value.lng,
                        name: currentLanguage === 'vi' ? (value.name_vi || value.name) : (value.name_en || value.name),
                        description: currentLanguage === 'vi' ? (value.description_vi || value.description) : (value.description_en || value.description)
                    };
                }

                // Kiểm tra xem địa điểm có trong danh sách lịch sử Việt Nam không
                for (const [key, value] of Object.entries(vietnamHistoricalLocations)) {
                    const keyNormalized = key.toLowerCase();
                    const nameEnNormalized = value.name_en ? value.name_en.toLowerCase() : '';
                    const nameViNormalized = value.name_vi ? value.name_vi.toLowerCase() : value.name.toLowerCase();

                    if (normalizedLocation.includes(keyNormalized) ||
                        (nameEnNormalized && normalizedLocation.includes(nameEnNormalized)) ||
                        (nameViNormalized && normalizedLocation.includes(nameViNormalized)) ||
                        (nameEnNormalized && transliteratedLocation.includes(nameEnNormalized))) {
                        return {
                            lat: value.lat,
                            lng: value.lng,
                            name: currentLanguage === 'vi' ? (value.name_vi || value.name) : (value.name_en || value.name),
                            description: currentLanguage === 'vi' ? (value.description_vi || value.description) : (value.description_en || value.description)
                        };
                    }
                }

                // Thử tìm kiếm với Nominatim
                let query = encodeURIComponent(locationName);
                let data;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1&accept-language=${currentLanguage}`, {
                        signal: AbortSignal.timeout(5000)
                    });
                    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                    data = await response.json();
                } catch (error) {
                    console.error(`Lỗi gọi Nominatim cho "${locationName}":`, error);
                }

                if (data && data.length > 0) {
                    const result = data[0];
                    return {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon),
                        name: result.display_name.split(',')[0],
                        description: null
                    };
                }

                console.warn(`Không tìm thấy tọa độ cho địa điểm: "${locationName}"`);
                return null;
            } catch (error) {
                console.error(`Lỗi khi lấy tọa độ cho "${locationName}":`, error);
                return null;
            }
        }

        function addKeyLocationMarker(lat, lng, name, description, index) {
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'key-location-marker',
                    html: `<div class="key-location">${index}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(map);

            let popupContent = `<div class="font-medium text-primary">${name}</div>`;
            if (description) {
                popupContent += `<div class="text-sm mt-1">${description}</div>`;
            }

            marker.bindPopup(popupContent);
            keyLocations.push(marker);
        }

        function generateNarrationText(data) {
            const isBattle = data.factions !== undefined;
            const isLandmark = data.purpose !== undefined && data.architecture !== undefined;
            const isFigure = data.achievements !== undefined && !isBattle;

            if (isBattle) {
                let narration = `Trận ${data.name || 'lịch sử'} diễn ra vào ${data.time || 'thời gian không xác định'}. `;
                if (data.location) {
                    narration += `Trận chiến diễn ra tại ${data.location}. `;
                }
                if (data.factions && data.factions.length > 0) {
                    narration += `Các phe tham gia gồm: ${data.factions.join(' và ')}. `;
                }
                if (data.timeline && data.timeline.length > 0) {
                    narration += `Diễn biến chính của trận chiến: `;
                    data.timeline.forEach((event, index) => {
                        narration += `Sự kiện ${index + 1}: ${event}. `;
                    });
                }
                if (data.outcome) {
                    narration += `Kết quả: ${data.outcome}. `;
                }
                if (data.significance) {
                    narration += `Ý nghĩa lịch sử: ${data.significance}. `;
                }
                return narration;
            } else if (isLandmark) {
                let narration = `Địa danh ${data.name || 'lịch sử'} tại ${data.location || 'địa điểm không xác định'}. `;
                if (data.build_time) {
                    narration += `Được xây dựng vào: ${data.build_time}. `;
                }
                if (data.purpose) {
                    narration += `Mục đích xây dựng: ${data.purpose}. `;
                }
                if (data.architecture) {
                    narration += `Đặc điểm kiến trúc: ${data.architecture}. `;
                }
                if (data.contents && data.contents.length > 0) {
                    narration += `Các công trình nổi bật bên trong gồm: ${data.contents.join(', ')}. `;
                }
                if (data.builders && data.builders.length > 0) {
                    narration += `Những người xây dựng: ${data.builders.join(', ')}. `;
                }
                if (data.dynasty) {
                    narration += `Thuộc triều đại: ${data.dynasty}. `;
                }
                return narration;
            } else if (isFigure) {
                let narration = `Nhân vật lịch sử ${data.name || 'không xác định'} sống vào ${data.time || 'thời gian không xác định'}. `;
                if (data.location) {
                    narration += `Nơi sinh hoặc hoạt động chính: ${data.location}. `;
                }
                if (data.summary) {
                    narration += `Tóm tắt tiểu sử: ${data.summary}. `;
                }
                if (data.achievements && data.achievements.length > 0) {
                    narration += `Các thành tựu nổi bật: ${data.achievements.join('; ')}. `;
                }
                if (data.significance) {
                    narration += `Ý nghĩa lịch sử: ${data.significance}. `;
                }
                return narration;
            }
            return "";
        }

        function createAudioControls(text, title) {
            const audioControls = document.createElement('div');
            audioControls.className = 'audio-controls';
            audioControls.innerHTML = `
                <div class="audio-controls-title">
                    <i class="fas fa-volume-up mr-2"></i>
                    ${translations[currentLanguage].audio_controls}
                </div>
                <div class="audio-controls-buttons">
                    <button id="play-audio" class="bg-primary text-white p-2 rounded-full hover:bg-secondary">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="pause-audio" class="bg-gray-500 text-white p-2 rounded-full hover:bg-gray-600" disabled>
                        <i class="fas fa-pause"></i>
                    </button>
                    <button id="stop-audio" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600">
                        <i class="fas fa-stop"></i>
                    </button>
                    <div class="audio-progress">
                        <div class="audio-progress-bar"></div>
                    </div>
                </div>
            `;

            // Add event listeners
            audioControls.querySelector('#play-audio').addEventListener('click', () => playSpeech(text, audioControls));
            audioControls.querySelector('#pause-audio').addEventListener('click', pauseSpeech);
            audioControls.querySelector('#stop-audio').addEventListener('click', stopSpeech);

            return audioControls;
        }

        function playSpeech(text, audioControls) {
            stopSpeech();

            currentSpeechText = text;
            speechSynthesisUtterance = new SpeechSynthesisUtterance(text);
            speechSynthesisUtterance.lang = currentLanguage === 'vi' ? 'vi-VN' : 'en-US';
            speechSynthesisUtterance.rate = 0.9;

            // Enable/disable buttons
            const playBtn = audioControls.querySelector('#play-audio');
            const pauseBtn = audioControls.querySelector('#pause-audio');
            const stopBtn = audioControls.querySelector('#stop-audio');
            const progressBar = audioControls.querySelector('.audio-progress-bar');

            if (playBtn) playBtn.disabled = true;
            if (pauseBtn) pauseBtn.disabled = false;
            if (stopBtn) stopBtn.disabled = false;

            let startTime = Date.now();
            const totalDuration = text.length / 10;

            speechProgressInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                const progress = Math.min(elapsed / totalDuration, 1) * 100;
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }

                if (progress >= 100) {
                    stopSpeech();
                }
            }, 100);

            speechSynthesisUtterance.onend = () => {
                stopSpeech();
            };

            speechSynthesis.speak(speechSynthesisUtterance);
            isSpeaking = true;
        }

        function pauseSpeech() {
            if (isSpeaking) {
                speechSynthesis.pause();
                isSpeaking = false;
                
                // Update all audio control buttons
                document.querySelectorAll('#play-audio').forEach(btn => {
                    btn.disabled = false;
                });
                document.querySelectorAll('#pause-audio').forEach(btn => {
                    btn.disabled = true;
                });
                
                if (speechProgressInterval) {
                    clearInterval(speechProgressInterval);
                    speechProgressInterval = null;
                }
            }
        }

        function stopSpeech() {
            if (speechSynthesisUtterance) {
                try {
                    speechSynthesis.cancel();
                    isSpeaking = false;

                    // Reset all progress bars
                    document.querySelectorAll('.audio-progress-bar').forEach(bar => {
                        bar.style.width = '0%';
                    });

                    // Enable play buttons, disable pause and stop buttons
                    document.querySelectorAll('#play-audio').forEach(btn => {
                        btn.disabled = false;
                    });

                    document.querySelectorAll('#pause-audio, #stop-audio').forEach(btn => {
                        btn.disabled = true;
                    });

                    if (speechProgressInterval) {
                        clearInterval(speechProgressInterval);
                        speechProgressInterval = null;
                    }
                } catch (e) {
                    console.error("Lỗi khi dừng giọng nói:", e);
                }
            }
        }

        function createResultContainer(title) {
            const container = document.createElement('div');
            container.className = 'result-container';
            container.innerHTML = `
                <div class="result-title">
                    <span>${title}</span>
                    <span class="close-btn cursor-pointer text-gray-500 hover:text-gray-700" onclick="this.parentElement.parentElement.remove();">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
                <div class="result-content mt-4"></div>
            `;
            return container;
        }

        function createImageContainer(title, imageUrl) {
            const container = document.createElement('div');
            container.className = 'image-container';
            container.innerHTML = `
                <div class="image-title relative">
                    ${translations[currentLanguage].picture}: ${title}
                    <span class="close-btn absolute top-2 right-2 cursor-pointer text-gray-500 hover:text-gray-700" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
                <img src="${imageUrl}" alt="${title}" class="image-content" />
            `;
            
            // Add click event to expand image
            container.querySelector('.image-content').addEventListener('click', function() {
                container.classList.toggle('expanded');
            });
            
            return container;
        }

        function createMindmapContainer(title, mindmapTitle) {
            const mindmapDiv = document.createElement('div');
            mindmapDiv.className = 'mindmap-container';
            mindmapDiv.innerHTML = `
                <div class="mindmap-title relative">
                    ${mindmapTitle}: ${title}
                    <span class="close-btn absolute top-2 right-2 cursor-pointer text-gray-500 hover:text-gray-700" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
                <div class="loading-mindmap">${translations[currentLanguage].typing_indicator}</div>
            `;

            mindmapDiv.addEventListener('click', function (e) {
                if (e.target === this || e.target.classList.contains('mindmap-title')) {
                    this.classList.toggle('expanded');
                }
            });

            return mindmapDiv;
        }

        async function generateMindmap(data, container, type) {
            try {
                let mindmapContent = "";
                
                if (type === "battle") {
                    mindmapContent = generateMermaidMindmap(data);
                } else if (type === "figure") {
                    mindmapContent = generateFigureMermaidMindmap(data);
                } else if (type === "landmark") {
                    mindmapContent = generateLandmarkMermaidMindmap(data);
                }

                const mindmapDiv = container.querySelector('.mindmap') || document.createElement('div');
                mindmapDiv.className = 'mindmap';
                mindmapDiv.textContent = mindmapContent;

                // Replace loading content with mindmap
                const loadingDiv = container.querySelector('.loading-mindmap');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
                container.appendChild(mindmapDiv);

                try {
                    await mermaid.run({
                        nodes: [mindmapDiv],
                    });
                } catch (mermaidError) {
                    console.error("Lỗi render Mermaid:", mermaidError);
                    container.innerHTML = `
                        <div class="mindmap-error">${translations[currentLanguage].processing_error}: ${mermaidError.message}</div>
                    `;
                }
            } catch (error) {
                console.error("Lỗi khi tạo sơ đồ tư duy:", error);
                container.innerHTML = `
                    <div class="mindmap-error">${translations[currentLanguage].processing_error}: ${error.message}</div>
                `;
            }
        }

        function generateLandmarkMermaidMindmap(landmarkData) {
            const safeText = (text) => {
                if (!text) return "";
                return text.toString()
                    .replace(/"/g, "'")
                    .replace(/[()<>[\]&:;]/g, "")
                    .replace(/\n/g, " ")
                    .replace(/\s+/g, " ")
                    .trim()
                    .substring(0, 150);
            };

            let mermaidCode = `mindmap\n`;

            // Nút gốc với class root-node
            mermaidCode += `  root(("${safeText(landmarkData.name) || translations[currentLanguage].unknown}"))\n`;
            mermaidCode += `    class root root-node\n`;

            // Nút vị trí với class location-node
            if (landmarkData.location) {
                mermaidCode += `    ${translations[currentLanguage].battle_location}\n`;
                mermaidCode += `      "${safeText(landmarkData.location)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].battle_location.replace(/\s+/g, '_')} location-node\n`;
            }

            // Nút thời gian xây dựng với class time-node
            if (landmarkData.build_time) {
                mermaidCode += `    ${translations[currentLanguage].landmark_build_time}\n`;
                mermaidCode += `      "${safeText(landmarkData.build_time)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].landmark_build_time.replace(/\s+/g, '_')} time-node\n`;
            }

            // Nút mục đích với class purpose-node
            if (landmarkData.purpose) {
                mermaidCode += `    ${translations[currentLanguage].landmark_purpose}\n`;
                mermaidCode += `      "${safeText(landmarkData.purpose)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].landmark_purpose.replace(/\s+/g, '_')} purpose-node\n`;
            }

            // Nút kiến trúc với class architecture-node
            if (landmarkData.architecture) {
                mermaidCode += `    ${translations[currentLanguage].landmark_architecture}\n`;
                mermaidCode += `      "${safeText(landmarkData.architecture)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].landmark_architecture.replace(/\s+/g, '_')} architecture-node\n`;
            }

            // Nút nội dung với class content-node
            if (landmarkData.contents && landmarkData.contents.length > 0) {
                mermaidCode += `    ${translations[currentLanguage].landmark_contents}\n`;
                landmarkData.contents.forEach(item => {
                    const safeItem = safeText(item);
                    mermaidCode += `      "${safeItem}"\n`;
                });
                mermaidCode += `    class ${translations[currentLanguage].landmark_contents.replace(/\s+/g, '_')} content-node\n`;
            }

            // Nút người xây dựng với class builder-node
            if (landmarkData.builders && landmarkData.builders.length > 0) {
                mermaidCode += `    ${translations[currentLanguage].landmark_builders}\n`;
                landmarkData.builders.forEach(builder => {
                    const safeBuilder = safeText(builder);
                    mermaidCode += `      "${safeBuilder}"\n`;
                });
                mermaidCode += `    class ${translations[currentLanguage].landmark_builders.replace(/\s+/g, '_')} builder-node\n`;
            }

            // Nút triều đại với class dynasty-node
            if (landmarkData.dynasty) {
                mermaidCode += `    ${translations[currentLanguage].landmark_dynasty}\n`;
                mermaidCode += `      "${safeText(landmarkData.dynasty)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].landmark_dynasty.replace(/\s+/g, '_')} dynasty-node\n`;
            }

            return mermaidCode;
        }

        function generateMermaidMindmap(battleData) {
            const safeText = (text) => {
                if (!text) return "";
                return text.toString()
                    .replace(/"/g, "'")
                    .replace(/[()<>[\]&:;]/g, "")
                    .replace(/\n/g, " ")
                    .replace(/\s+/g, " ")
                    .trim()
                    .substring(0, 150);
            };

            let mermaidCode = `mindmap\n`;

            // Root node với class root-node
            mermaidCode += `  root(("${safeText(battleData.name) || translations[currentLanguage].unknown}"))\n`;
            mermaidCode += `    class root root-node\n`;

            // Time node với class time-node
            if (battleData.time) {
                mermaidCode += `    ${translations[currentLanguage].battle_time}\n`;
                mermaidCode += `      "${safeText(battleData.time)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].battle_time.replace(/\s+/g, '_')} time-node\n`;
            }

            // Location node với class location-node
            if (battleData.location) {
                mermaidCode += `    ${translations[currentLanguage].battle_location}\n`;
                mermaidCode += `      "${safeText(battleData.location)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].battle_location.replace(/\s+/g, '_')} location-node\n`;
            }

            // Factions node với class faction-node
            if (battleData.factions && battleData.factions.length > 0) {
                mermaidCode += `    ${translations[currentLanguage].battle_factions}\n`;
                battleData.factions.forEach(faction => {
                    const safeFaction = safeText(faction);
                    mermaidCode += `      "${safeFaction}"\n`;

                    if (battleData.commanders && battleData.commanders[faction]) {
                        const safeCommander = safeText(battleData.commanders[faction]);
                        mermaidCode += `        "${translations[currentLanguage].battle_commanders}: ${safeCommander}"\n`;
                    }
                });
                mermaidCode += `    class ${translations[currentLanguage].battle_factions.replace(/\s+/g, '_')} faction-node\n`;
            }

            // Timeline node với class time-node
            if (battleData.timeline && battleData.timeline.length > 0) {
                mermaidCode += `    ${translations[currentLanguage].battle_timeline}\n`;
                battleData.timeline.forEach((event, index) => {
                    const safeEvent = safeText(event);
                    mermaidCode += `      "${translations[currentLanguage].event} ${index + 1}: ${safeEvent}"\n`;
                });
                mermaidCode += `    class ${translations[currentLanguage].battle_timeline.replace(/\s+/g, '_')} time-node\n`;
            }

            // Outcome node với class outcome-node
            if (battleData.outcome) {
                mermaidCode += `    ${translations[currentLanguage].battle_outcome}\n`;
                mermaidCode += `      "${safeText(battleData.outcome)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].battle_outcome.replace(/\s+/g, '_')} outcome-node\n`;
            }

            // Significance node với class significance-node
            if (battleData.significance) {
                mermaidCode += `    ${translations[currentLanguage].battle_significance}\n`;
                mermaidCode += `      "${safeText(battleData.significance)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].battle_significance.replace(/\s+/g, '_')} significance-node\n`;
            }

            return mermaidCode;
        }

        function generateFigureMermaidMindmap(figureData) {
            const safeText = (text) => {
                if (!text) return "";
                return text.toString()
                    .replace(/"/g, "'")
                    .replace(/[()<>[\]&:;]/g, "")
                    .replace(/\n/g, " ")
                    .replace(/\s+/g, " ")
                    .trim()
                    .substring(0, 150);
            };

            let mermaidCode = `mindmap\n`;

            // Root node với class root-node
            mermaidCode += `  root(("${safeText(figureData.name) || translations[currentLanguage].unknown}"))\n`;
            mermaidCode += `    class root root-node\n`;

            // Time node với class time-node
            if (figureData.time) {
                mermaidCode += `    ${translations[currentLanguage].battle_time}\n`;
                mermaidCode += `      "${safeText(figureData.time)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].battle_time.replace(/\s+/g, '_')} time-node\n`;
            }

            // Location node với class location-node
            if (figureData.location) {
                mermaidCode += `    ${translations[currentLanguage].birth_place}\n`;
                mermaidCode += `      "${safeText(figureData.location)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].birth_place.replace(/\s+/g, '_')} location-node\n`;
            }

            // Achievements node với class achievement-node
            if (figureData.achievements && figureData.achievements.length > 0) {
                mermaidCode += `    ${translations[currentLanguage].battle_achievements}\n`;
                figureData.achievements.forEach(achievement => {
                    const safeAchievement = safeText(achievement);
                    mermaidCode += `      "${safeAchievement}"\n`;
                });
                mermaidCode += `    class ${translations[currentLanguage].battle_achievements.replace(/\s+/g, '_')} achievement-node\n`;
            }

            // Significance node với class significance-node
            if (figureData.significance) {
                mermaidCode += `    ${translations[currentLanguage].battle_significance}\n`;
                mermaidCode += `      "${safeText(figureData.significance)}"\n`;
                mermaidCode += `      class ${translations[currentLanguage].battle_significance.replace(/\s+/g, '_')} significance-node\n`;
            }

            return mermaidCode;
        }

        async function extractCountriesFromFactions(factions) {
            const countries = [];
            for (const faction of factions) {
                for (const country in countryCoordinates) {
                    if (faction.includes(country)) {
                        countries.push(currentLanguage === 'en' ? countryNameMap[country] || country : country);
                        break;
                    }
                }
            }
            return [...new Set(countries)];
        }

        function addMarker(lat, lng, title) {
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div class="battle-marker">
                              <i class="fas fa-map-marker-alt"></i>
                          </div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map)
                .bindPopup(`<div class="font-medium text-primary">${title}</div>`)
                .openPopup();
            markers.push(marker);
        }

        function formatBattleData(data) {
            return `
    <div class="battle-box">
        <h3><i class="fas fa-clock"></i> ${translations[currentLanguage].battle_time}</h3>
        <p>${data.time || translations[currentLanguage].unknown}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-map-marked-alt"></i> ${translations[currentLanguage].battle_location}</h3>
        <p>${data.location || translations[currentLanguage].unknown}</p>
        ${data.lat && data.lng ? `<p class="mt-2 text-sm text-gray-600">${translations[currentLanguage].latitude}: ${data.lat}, ${translations[currentLanguage].longitude}: ${data.lng}</p>` : ''}
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-align-left"></i> ${translations[currentLanguage].battle_summary}</h3>
        <p>${data.summary || translations[currentLanguage].no_summary}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-users"></i> ${translations[currentLanguage].battle_factions}</h3>
        <ul>${data.factions ? data.factions.map(faction => `<li>${faction}</li>`).join("") : `<li>${translations[currentLanguage].unknown}</li>`}</ul>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-user-shield"></i> ${translations[currentLanguage].battle_troops}</h3>
        <ul>${data.troop_numbers ? Object.entries(data.troop_numbers).map(([faction, troops]) => `<li>${faction}: ${troops}</li>`).join("") : `<li>${translations[currentLanguage].unknown}</li>`}</ul>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-crown"></i> ${translations[currentLanguage].battle_commanders}</h3>
        <ul>${data.commanders ? Object.entries(data.commanders).map(([faction, commander]) => `<li>${faction}: ${commander}</li>`).join("") : `<li>${translations[currentLanguage].unknown}</li>`}</ul>
    </div>
    ${data.heroes && data.heroes.length > 0 ? `
    <div class="battle-box">
        <h3><i class="fas fa-star"></i> ${translations[currentLanguage].battle_heroes}</h3>
        <ul>${data.heroes.map(hero => `<li>${hero.name} (${hero.role}): ${hero.description}</li>`).join("")}</ul>
    </div>
    ` : ''}
    ${data.outcome ? `
    <div class="battle-box">
        <h3><i class="fas fa-trophy"></i> ${translations[currentLanguage].battle_outcome}</h3>
        <p>${data.outcome}</p>
    </div>
    ` : ''}
    ${data.significance ? `
    <div class="battle-box">
        <h3><i class="fas fa-lightbulb"></i> ${translations[currentLanguage].battle_significance}</h3>
        <p>${data.significance}</p>
    </div>
    ` : ''}
    `;
        }

        function formatFigureData(data) {
            const locationDescription = currentLanguage === 'en' ?
                data.description_en || translations[currentLanguage].unknown :
                data.description_vi || translations[currentLanguage].unknown;

            return `
    <div class="battle-box">
        <h3><i class="fas fa-user"></i> ${translations[currentLanguage].battle_name}</h3>
        <p>${data.name || translations[currentLanguage].unknown}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-clock"></i> ${translations[currentLanguage].battle_time}</h3>
        <p>${data.time || translations[currentLanguage].unknown}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-map-marker-alt"></i> ${translations[currentLanguage].birth_place}</h3>
        <p>${data.location || translations[currentLanguage].unknown}</p>
        ${locationDescription ? `<p class="mt-2 text-sm text-gray-600">${locationDescription}</p>` : ''}
        ${data.lat && data.lng ? `<p class="mt-2 text-sm text-gray-600">${translations[currentLanguage].latitude}: ${data.lat}, ${translations[currentLanguage].longitude}: ${data.lng}</p>` : ''}
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-align-left"></i> ${translations[currentLanguage].battle_summary}</h3>
        <p>${data.summary || translations[currentLanguage].no_summary}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-star"></i> ${translations[currentLanguage].battle_achievements}</h3>
        <ul>${data.achievements ? data.achievements.map(achievement => `<li>${achievement}</li>`).join("") : `<li>${translations[currentLanguage].unknown}</li>`}</ul>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-lightbulb"></i> ${translations[currentLanguage].battle_significance}</h3>
        <p>${data.significance || translations[currentLanguage].unknown}</p>
    </div>
    `;
        }

        function formatLandmarkData(data) {
            const locationDescription = currentLanguage === 'en' ?
                transliterateVietnamese(data.description_en || translations[currentLanguage].unknown) :
                data.description_vi || translations[currentLanguage].unknown;

            return `
    <div class="battle-box">
        <h3><i class="fas fa-landmark"></i> ${translations[currentLanguage].landmark_name}</h3>
        <p>${data.name || translations[currentLanguage].unknown}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-map-marker-alt"></i> ${translations[currentLanguage].battle_location}</h3>
        <p>${data.location || translations[currentLanguage].unknown}</p>
        ${locationDescription ? `<p class="mt-2 text-sm text-gray-600">${locationDescription}</p>` : ''}
        ${data.lat && data.lng ? `<p class="mt-2 text-sm text-gray-600">${translations[currentLanguage].latitude}: ${data.lat}, ${translations[currentLanguage].longitude}: ${data.lng}</p>` : ''}
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-clock"></i> ${translations[currentLanguage].landmark_build_time}</h3>
        <p>${data.build_time || translations[currentLanguage].unknown}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-bullseye"></i> ${translations[currentLanguage].landmark_purpose}</h3>
        <p>${data.purpose || translations[currentLanguage].unknown}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-building"></i> ${translations[currentLanguage].landmark_architecture}</h3>
        <p>${data.architecture || translations[currentLanguage].unknown}</p>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-box-open"></i> ${translations[currentLanguage].landmark_contents}</h3>
        <ul>${data.contents ? data.contents.map(item => `<li>${item}</li>`).join("") : `<li>${translations[currentLanguage].unknown}</li>`}</ul>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-users"></i> ${translations[currentLanguage].landmark_builders}</h3>
        <ul>${data.builders ? data.builders.map(builder => `<li>${builder}</li>`).join("") : `<li>${translations[currentLanguage].unknown}</li>`}</ul>
    </div>
    <div class="battle-box">
        <h3><i class="fas fa-crown"></i> ${translations[currentLanguage].landmark_dynasty}</h3>
        <p>${data.dynasty || translations[currentLanguage].unknown}</p>
    </div>
    `;
        }

        function addMessageToUI(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${role === 'user' ? 'text-right' : 'text-left'}`;

            const bubbleClass = role === 'user'
                ? 'bg-primary text-white rounded-tr-none'
                : 'bg-white text-gray-800 rounded-tl-none shadow-sm border border-gray-200';

            let translatedContent = content;
            if (content.includes("Xin lỗi, tôi chỉ trả lời các câu hỏi liên quan đến lịch sử")) {
                translatedContent = translations[currentLanguage].non_history_error;
            } else if (content.includes("Lỗi tải dữ liệu bản đồ")) {
                translatedContent = translations[currentLanguage].map_error;
            } else if (content.includes("Lỗi khi xử lý yêu cầu")) {
                translatedContent = translations[currentLanguage].processing_error;
            } else {
                translatedContent = formatMessage(content);
            }

            messageDiv.innerHTML = `
                <div class="inline-block max-w-[85%] rounded-xl p-4 ${bubbleClass} relative">
                    <div class="message-content">${translatedContent}</div>
                    ${role === 'assistant' ? `
                    <span class="close-btn absolute top-2 right-2 cursor-pointer text-gray-500 hover:text-gray-700" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </span>
                    ` : ''}
                </div>
            `;

            resultMessages.appendChild(messageDiv);
            scrollToTop();
        }

        function formatMessage(content) {
            if (!content) return '';

            let formatted = content.replace(/```([\w]*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const langDisplay = lang ? lang : 'text';
                return `<div class="code-block">
                    <div class="code-header flex justify-between items-center px-3 py-2 bg-gray-800 text-gray-300 text-xs rounded-t-md">
                        <span>${langDisplay}</span>
                        <button class="copy-code-btn hover:text-white" onclick="copyToClipboard(this)" data-code="${encodeURIComponent(code.trim())}">
                            <i class="fas fa-copy mr-1"></i> <span>${translations[currentLanguage].copy_code}</span>
                        </button>
                    </div>
                    <pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>
                </div>`;
            });

            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-gray-800 px-1 py-0.5 rounded text-white">$1</code>');

            formatted = formatted.split('\n\n').map(paragraph => {
                if (paragraph.trim().startsWith('<') && paragraph.trim().endsWith('>')) {
                    return paragraph;
                }
                return `<p>${paragraph}</p>`;
            }).join('');

            formatted = formatted.replace(/\n(?![<])/g, '<br>');

            return formatted;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function scrollToTop() {
            setTimeout(() => {
                const contentContainer = document.querySelector('.content-container');
                if (contentContainer) {
                    contentContainer.scrollTop = 0;
                }
            }, 100);
        }

        function copyToClipboard(button) {
            const code = decodeURIComponent(button.getAttribute('data-code'));
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = `<i class="fas fa-check mr-1"></i> ${translations[currentLanguage].copied}`;
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        }

        async function getWikipediaImage(query) {
            try {
                const lang = currentLanguage === 'vi' ? 'vi' : 'en';
                const searchUrl = `https://${lang}.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.query.search.length === 0) {
                    console.warn(`Không tìm thấy bài viết Wikipedia cho "${query}"`);
                    return null;
                }

                const title = searchData.query.search[0].title;
                const imageUrl = `https://${lang}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=pageimages&format=json&pithumbsize=500&origin=*`;
                const imageResponse = await fetch(imageUrl);
                const imageData = await imageResponse.json();

                const pages = imageData.query.pages;
                const pageId = Object.keys(pages)[0];
                const imageInfo = pages[pageId].thumbnail;

                return imageInfo ? imageInfo.source : null;
            } catch (error) {
                console.error('Lỗi khi lấy ảnh từ Wikipedia:', error);
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
        window.copyToClipboard = copyToClipboard;
        window.closeHistoryInfo = closeHistoryInfo;
        window.toggleSidebar = toggleSidebar;
    </script>
</body>

</html>
